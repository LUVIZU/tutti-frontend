<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ìê²©ì¦ ì„ íƒ</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        margin: 0;
        font-family: "Pretendard", Arial, sans-serif;
        background: linear-gradient(to bottom right, #eaf6ff, #ffffff);
        overflow-x: hidden;
        overflow-y: hidden;
        min-height: 100vh;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
      }

      .logo {
        height: 52px;
      }

      .nav-menu {
        display: flex;
        gap: 2px;
        align-items: center;
        font-weight: 500;
        font-size: 18px;
        color: #1e1e1e;
      }

      .nav-menu span,
      .nav-menu .profile-icon {
        padding: 0 16px;
        position: relative;
        display: flex;
        align-items: center;
      }

      .nav-menu span:not(:first-child)::before,
      .nav-menu .profile-icon::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 1px;
        height: 24px;
        background-color: #ccc;
      }

      .top-message {
        display: none;
        padding: 30px 60px 0 60px;
        font-size: 24px;
        font-weight: 500;
        color: #000000;
        line-height: 1.6;
      }

      .top-message strong {
        color: #007aff;
      }

      .main-wrapper {
        display: flex;
        justify-content: center;
        gap: 40px;
        padding: 40px 40px 60px;
      }

      .left-panel {
        background: linear-gradient(180deg, #f8fbfe 0%, #f1f6fa 100%);
        border-radius: 20px;
        padding: 40px;
        width: 1151px;
        min-height: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: height 0.3s ease;
      }

      .intro-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        gap: 20px;
      }

      .intro-box img {
        width: 120px;
      }

      .speech {
        background: #fff;
        padding: 24px;
        border-radius: 15px;
        font-size: 30px;
        font-weight: 400;
        line-height: 1.6;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.05);
      }

      .community-list {
        display: none;
        flex-direction: column;
        gap: 30px;
      }

      .community-box {
        background: #fff;
        border-radius: 10px;
        padding: 24px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
      }

      .community-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 20px;
        font-weight: 600;
        color: #222;
        margin-bottom: 12px;
      }

      .community-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 36px;
        font-weight: 600;
      }

      .community-posts {
        font-size: 20px;
        font-weight: 400;
        line-height: 1.5;
        color: #444;
        margin-left: 34px;
      }

      .exam-selector {
        background: #f8fafd;
        border-radius: 20px;
        padding: 30px;
        width: 564px;
        height: 930px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow-y: auto;
        text-align: center; /* âœ… ê°€ìš´ë° ì •ë ¬ */
      }

      .exam-selector h2 {
        font-size: 24px;
        font-weight: 700;
        color: #1e3a8a;
        margin-bottom: 4px;
      }

      .exam-selector small {
        display: block;
        font-size: 16px;
        margin-bottom: 20px;
        color: #666;
      }

      details {
        margin-top: 10px;
        border-radius: 12px;
        overflow: hidden;
        background: #ffffff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-left: 8px solid #007aff;
      }

      summary {
        font-size: 18px;
        font-weight: 600;
        background: #ffffff;
        padding: 16px 20px;
        cursor: pointer;
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      summary::after {
        content: "â–¾";
        font-size: 16px;
        color: #007aff;
      }

      ul {
        list-style: none;
        padding: 0 20px 10px 20px;
        margin: 0;
      }

      li {
        padding: 10px;
        border-radius: 8px;
        transition: background 0.2s;
        display: flex;
        align-items: center;
      }

      li:hover {
        background-color: #f0f7ff;
      }

      input[type="checkbox"] {
        accent-color: #007aff;
        margin-right: 8px;
      }

      .community-header a,
      .community-posts a {
        color: #444;
        text-decoration: none;
        display: block;
        margin-bottom: 4px;
      }

      .community-posts a:last-child {
        margin-bottom: 0;
      }

      .community-header a:hover,
      .community-posts a:hover {
        text-decoration: underline;
      }
      .nav-menu a {
        color: inherit;
        text-decoration: none;
        display: flex;
        align-items: center;
        height: 100%;
      }
      .nav-menu a:hover {
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <header>
      <img src="./icons/tutti.png" alt="Tutti Logo" class="logo" />
      <div class="nav-menu">
        <a href="CommuForm.html"><span>í™ˆ</span></a>
        <a href="notifications.html"><span>ì•Œë¦¼</span></a>
        <a href="MyPage.html" class="profile-icon">
          <img src="icons/profile.png" alt="profile" width="37" />
        </a>
      </div>
    </header>

    <div class="top-message" id="top-message">
      <p>
        <strong class="nickname-placeholder">â€œë‹‰ë„¤ì„â€</strong> ë‹˜ì˜ ë²„í‚·ë¦¬ìŠ¤íŠ¸ê°€
        ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!<br />
        ì•ìœ¼ë¡œì˜ ì‹œê°„, ë‹¹ì‹ ì´ ì£¼ì¸ê³µì´ì—ìš”.
      </p>
    </div>

    <div class="main-wrapper">
      <div class="left-panel" id="left-panel">
        <div class="intro-box" id="intro-box">
          <img src="./icons/profile.png" alt="user" />
          <div class="speech">
            <strong class="nickname-placeholder">â€œë‹‰ë„¤ì„â€</strong>ë‹˜, ì•„ì§
            ì°¸ì—¬í•œ ì»¤ë®¤ë‹ˆí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.<br />
            ê´€ì‹¬ ìˆëŠ” ìê²©ì¦ì„ ì„ íƒí•´, í•¨ê»˜ ê³µë¶€í•  ì¹œêµ¬ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”!
          </div>
        </div>
        <div class="community-list" id="community-list"></div>
      </div>

      <div class="exam-selector">
        <h2>âœ” ê³µë¶€í•  ìê²©ì¦ì„ ì„ íƒí•´ì£¼ì„¸ìš”!</h2>
        <small>ìê²©ì¦ì€ 3ê°œê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆì–´ìš”.</small>
        <div id="exam-container"></div>
      </div>
    </div>

    <script src="./config.js"></script>

    <script type="module">
      const categoryMap = [
        { id: 1, name: "ì–´í•™" },
        { id: 2, name: "IT â€¢ ì •ë³´í†µì‹ " },
        { id: 3, name: "ê²½ì˜" },
        { id: 4, name: "ê³µí•™  " },
        { id: 7, name: "í†µê³„" },
        { id: 6, name: "ì—­ì‚¬" },
        { id: 5, name: "ê¸°íƒ€" },
      ];
      let token = null;
      let loginId = null;

      let validCommunityExamIds = [];
      document.addEventListener("DOMContentLoaded", async () => {
        token = localStorage.getItem("accessToken");
        loginId = localStorage.getItem("loginId"); // â† ë°˜ë“œì‹œ ë¡œê·¸ì¸ ì‹œ ì €ì¥í•´ë‘˜ ê²ƒ

        console.log("í† í° ê°’ í™•ì¸:", token);

        if (!token || !loginId) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          window.location.href = "index.html";
          return;
        }

        // âœ… ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ ë¨¼ì € ë°›ì•„ì˜¤ê¸°
        try {
          const res = await fetch(`${window.BASE_URL}/api/communities`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });

          if (!res.ok) throw new Error("ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨");

          const data = await res.json();

          // validCommunityExamIdsì— ì €ì¥ (ì˜ˆ: [3, 5, 8])
          validCommunityExamIds = data.map((item) => item.examId);
          console.log("ìœ íš¨í•œ ì»¤ë®¤ë‹ˆí‹° ëª©ë¡:", validCommunityExamIds);
          console.log("ì»¤ë®¤ë‹ˆí‹° examId ëª©ë¡:", validCommunityExamIds);
        } catch (err) {
          console.error("ì»¤ë®¤ë‹ˆí‹° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        }

        // âœ… ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
        try {
          // BASE_URL -> window.BASE_URLë¡œ ìˆ˜ì •
          const userRes = await fetch(
            `${window.BASE_URL}/api/users/${loginId}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!userRes.ok) throw new Error("íšŒì› ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");

          const userData = await userRes.json();

          console.log("ì‹¤ì œ ì‘ë‹µ ë°ì´í„°:", userData);

          const userInfo =
            Array.isArray(userData.data) && userData.data.length > 0
              ? userData.data[0]
              : null;
          const nickname = userInfo ? userInfo.nickname : null;

          document.querySelectorAll(".nickname-placeholder").forEach((el) => {
            el.textContent = nickname ? `â€œ${nickname}â€` : "â€œë‹‰ë„¤ì„ ì—†ìŒâ€";
          });
        } catch (err) {
          console.error("ë‹‰ë„¤ì„ ë¡œë”© ì‹¤íŒ¨:", err);
        }

        try {
          const examData = [];

          for (const category of categoryMap) {
            // BASE_URL -> window.BASE_URLë¡œ ìˆ˜ì •
            const res = await fetch(
              `${window.BASE_URL}/api/categories/${category.id}/exams`,
              {
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
              }
            );

            if (!res.ok) {
              if (res.status === 403) {
                throw new Error(
                  "403 Forbidden: í† í°ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."
                );
              }
              throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }

            const data = await res.json();
            examData.push({
              category: category.name,
              exams: data.map((exam) => ({ id: exam.id, name: exam.name })),
            });
          }

          renderCategories(examData);
        } catch (err) {
          console.error("ì‹œí—˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
          document.getElementById("exam-container").innerHTML =
            "<p style='color:red;'>ìê²©ì¦ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>";
        }
      });

      function renderCategories(categories) {
        const container = document.getElementById("exam-container");
        const communityList = document.getElementById("community-list");
        const introBox = document.getElementById("intro-box");
        const topMessage = document.getElementById("top-message");
        const leftPanel = document.getElementById("left-panel");

        container.innerHTML = "";
        let selected = JSON.parse(localStorage.getItem("selectedExams")) || [];

        categories.forEach((cat) => {
          const details = document.createElement("details");
          const summary = document.createElement("summary");
          summary.textContent = cat.category;
          details.appendChild(summary);

          const ul = document.createElement("ul");

          cat.exams.forEach((examObj) => {
            const { id, name } = examObj;
            const li = document.createElement("li");
            const label = document.createElement("label");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = id;
            checkbox.dataset.name = name; // ì´ë¦„ë„ ë³´ê´€

            if (selected.includes(name)) {
              checkbox.checked = true;
            }
            const examId = examObj.id; // ì´ë¯¸ ì´ ì •ë³´ê°€ ìˆìŒ

            checkbox.addEventListener("change", async () => {
              const examId = parseInt(checkbox.value);

              if (checkbox.checked) {
                if (selected.length >= 3) {
                  checkbox.checked = false;
                  alert("ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                  return;
                } else {
                  selected.push(name);

                  try {
                    const res = await fetch(
                      `${window.BASE_URL}/api/communities/${examId}/join`,
                      {
                        method: "POST",
                        headers: {
                          Authorization: `Bearer ${token}`,
                          "Content-Type": "application/json",
                        },
                      }
                    );

                    let jsonResponse;
                    try {
                      jsonResponse = await res.json();
                    } catch (e) {
                      console.warn("JSON ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:", e);
                      jsonResponse = {};
                    }

                    if (!res.ok) {
                      let errorMessage = `ì°¸ì—¬ ì‹¤íŒ¨: HTTP ${res.status} - ${res.statusText}`;
                      if (
                        jsonResponse.message?.includes(
                          "ì´ë¯¸ ê°€ì…ëœ ì»¤ë®¤ë‹ˆí‹°ì…ë‹ˆë‹¤"
                        )
                      ) {
                        alert("ì´ë¯¸ ê°€ì…ëœ ì»¤ë®¤ë‹ˆí‹°ì…ë‹ˆë‹¤.");
                        checkbox.checked = true;
                        checkbox.disabled = true;
                        selected = [...new Set([...selected, name])];
                        updateDisabling();
                        updateCommunityUI();
                        return;
                      } else {
                        errorMessage += `\nì„œë²„ ë©”ì‹œì§€: ${
                          jsonResponse.message || ""
                        }`;
                      }
                      throw new Error(errorMessage);
                    }

                    console.log("ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬ ì„±ê³µ:", jsonResponse);
                  } catch (err) {
                    console.error("ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬ ì˜¤ë¥˜:", err);
                    alert("ì„œë²„ì— ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬ë¥¼ ë“±ë¡í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                  }
                }
              } else {
                // ì²´í¬ í•´ì œ ì‹œ â†’ íƒˆí‡´ ë¡œì§
                try {
                  const res = await fetch(
                    `${window.BASE_URL}/api/communities/${examId}/leave`,
                    {
                      method: "DELETE",
                      headers: {
                        Authorization: `Bearer ${token}`,
                      },
                    }
                  );

                  if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || "íƒˆí‡´ ì‹¤íŒ¨");
                  }

                  alert("ì»¤ë®¤ë‹ˆí‹°ì—ì„œ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤.");

                  // ì„ íƒëœ ëª©ë¡ì—ì„œ ì œê±°
                  selected = selected.filter((nameItem) => nameItem !== name);

                  // localStorage ì—…ë°ì´íŠ¸
                  localStorage.setItem(
                    "selectedExams",
                    JSON.stringify(selected)
                  );

                  // UI ê°±ì‹ 
                  updateDisabling();
                  updateCommunityUI();
                } catch (err) {
                  console.error("ì»¤ë®¤ë‹ˆí‹° íƒˆí‡´ ì˜¤ë¥˜:", err);
                  alert("íƒˆí‡´ ì‹¤íŒ¨: " + err.message);
                  checkbox.checked = true; // ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ ì²´í¬
                }
              }

              // ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì„ íƒ ê°’ ì €ì¥ ë° UI ê°±ì‹ 
              localStorage.setItem("selectedExams", JSON.stringify(selected));
              updateDisabling();
              updateCommunityUI();
            });

            label.appendChild(checkbox);
            label.append(" " + name);
            li.appendChild(label);
            ul.appendChild(li);
          });

          details.appendChild(ul);
          container.appendChild(details);
        });

        function updateDisabling() {
          const allCheckboxes = document.querySelectorAll(
            "input[type=checkbox]"
          );
          allCheckboxes.forEach((cb) => {
            if (!cb.checked && selected.length >= 3) {
              cb.disabled = true;
            } else {
              cb.disabled = false;
            }
          });
        }

        function updateCommunityUI() {
          const selectedCount = selected.length;

          if (selectedCount > 0) {
            introBox.style.display = "none";
            communityList.style.display = "flex";
            topMessage.style.display = "block";
            communityList.innerHTML = "";

            selected.forEach((exam) => {
              const box = document.createElement("div");
              box.className = "community-box";
              box.innerHTML = `
              <div class="community-header">
                <a href="Community.html">
                  <div class="community-title">
                    <img src="icons/award.png" alt="ğŸ“¢" width="42" height="40" />
                    ${exam} ì»¤ë®¤ë‹ˆí‹°
                  </div>
                </a>
                <span style="font-size: 14px; color: #888;">ğŸ“… 2025.06.24</span>
              </div>
              <div class="community-posts">
                <a href="/community/${encodeURIComponent(
                  exam
                )}/post1">ì´ ìê²©ì¦ì˜ ìµœì‹  ê³µë¶€ë²•ì€?</a>
                <a href="/community/${encodeURIComponent(
                  exam
                )}/post2">ì‹¤ì „ ëŒ€ë¹„ ê¿€íŒ ë‚˜ëˆ ìš”!</a>
                <a href="/community/${encodeURIComponent(
                  exam
                )}/post3">ì§ˆë¬¸ ìˆì–´ìš”~</a>
              </div>
            `;

              communityList.appendChild(box);
            });

            const heightPerItem = 170;
            const paddingOffset = 280;
            const totalHeight = selectedCount * heightPerItem + paddingOffset;
            leftPanel.style.height = `${totalHeight}px`;
          } else {
            introBox.style.display = "flex";
            communityList.style.display = "none";
            topMessage.style.display = "none";
            leftPanel.style.height = "786px";
          }
        }

        updateDisabling();
        updateCommunityUI();
      }
    </script>
  </body>
</html>
