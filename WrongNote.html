<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>ë¯¸ì…˜</title>
    <style>
      /* ê¸°ì¡´ CSSëŠ” ìœ ì§€ë©ë‹ˆë‹¤ */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      .blur-circle {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
        z-index: 0;
      }

      .blur-circle-1 {
        width: 783px;
        height: 783px;
        background: #ddf2ff;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        filter: blur(500px);
        opacity: 1;
      }

      .blur-circle-2 {
        width: 507px;
        height: 507px;
        background: #b0dcf7;
        top: 240px;
        left: 60%;
        transform: translateX(-50%);
        filter: blur(250px);
        opacity: 0.2;
      }

      .header,
      .wrapper,
      .sidebar,
      .content {
        position: relative;
        z-index: 10;
      }

      .logo img {
        width: 128px;
        height: 52px;
      }

      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        padding-top: 100px;
      }

      .wrapper {
        width: 90vw;
        max-width: 1280px;
        margin: 0 auto;
        padding-top: 20px;
        display: flex;
        flex-direction: row;
        gap: 0;
      }

      .header {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 80px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 5vw;
        z-index: 1000;
      }

      .header .user-actions {
        display: flex;
        align-items: center;
        width: auto;
        height: 42px;
        gap: 14px;
      }

      .nav-box {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 37px;
        padding: 10px 14px;
        font-size: 20px;
        font-weight: 500;
        border-right: 1px solid #e1e1e1;
        position: relative;
      }

      .notification {
        position: relative;
      }

      .badge {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 18px;
        height: 18px;
        background: #ff3b3b;
        color: white;
        font-size: 12px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .profile-btn {
        width: 37px;
        height: 37px;
        border: 1px solid #247eb6;
        border-radius: 1000px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
      }

      .profile-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .sidebar {
        width: 280px;
        height: auto;
        padding: 2px;
        background-color: white;
        border-top: 5px solid #247eb6;
        flex-shrink: 0;
        flex-grow: 0;
      }

      .sidebar h2 {
        color: #247eb6;
        font-family: "Inter", sans-serif;
        font-weight: 700;
        font-size: 36px;
        margin-top: 30px;
        text-align: center;
      }

      .stats {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10.67px;
        margin-top: 15px;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 16px;
        color: #000;
      }

      .stat-item img.user-icon {
        width: 26.27px;
        height: 20.3px;
      }

      .stat-item img.calendar-icon {
        width: 18.67px;
        height: 18.67px;
      }

      .stat-item img.day-icon {
        width: 13.33px;
        height: 17px;
      }

      .write-button {
        margin: 20px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 200px;
        height: 40px;
        background-color: #b0dcf7;
        border-radius: 21.02px;
        gap: 7.01px;
        color: white;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
      }

      .write-button img {
        width: 18px;
        height: 18px;
      }

      .sidebar ul {
        list-style: none;
        margin-top: 20px;
        padding: 0 15px;
      }

      .sidebar li {
        display: flex;
        margin-bottom: 10px;
        cursor: pointer;
        align-items: center;
        flex-wrap: wrap;
      }

      .sidebar li .menu-item-link,
      .sidebar li .mission-main-link {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        color: black;
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        transition: background-color 0.2s, color 0.2s;
      }

      .sidebar li .menu-item-link.active,
      .sidebar li .mission-main-link.active {
        background-color: #e6f4fd;
      }

      .sidebar li .menu-item-link.active span,
      .sidebar li .mission-main-link.active span {
        color: #247eb6;
        font-weight: 600;
      }

      .sidebar li[data-icon="group"] {
        border-bottom: 1px solid #e1e1e1;
        padding-bottom: 20px;
        margin-bottom: 10px;
      }
      .sidebar li[data-icon="mission"] {
        border-bottom: 1px solid #e1e1e1;
        padding-bottom: 20px;
        margin-bottom: 10px;
      }
      .sidebar li[data-icon="calendar"] {
        border-bottom: 1px solid #e1e1e1;
        padding-bottom: 20px;
        margin-bottom: 10px;
      }

      #mission-submenu {
        padding-left: 0;
        list-style: none;
        display: none;
        margin-top: 5px;
        width: 100%;
      }

      #mission-submenu li {
        display: block;
        padding: 0;
        margin-bottom: 5px;
        border-radius: 0;
      }

      #mission-submenu li a {
        display: flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        color: black;
        width: 100%;
        padding: 8px 15px 8px 30px;
        border-radius: 8px;
        transition: background-color 0.2s, color 0.2s, border 0.2s;
        white-space: nowrap;
      }

      #mission-submenu li a img {
        width: 16px;
        height: 16px;
      }

      #mission-submenu li a.active {
        background-color: #e6f4fd;
        color: #247eb6;
        font-weight: 600;
        border: 1px solid #247eb6;
      }

      #mission-submenu li a.active span {
        color: #247eb6;
        font-weight: 600;
      }

      #mission-submenu li:last-child {
        margin-bottom: 0;
      }

      .icon-all {
        width: 26px;
        height: 26px;
      }
      .icon-star {
        width: 27px;
        height: 26px;
      }
      .icon-info {
        width: 27px;
        height: 26px;
      }
      .icon-group {
        width: 37px;
        height: 26px;
      }
      .icon-mission {
        width: 20.8px;
        height: 26px;
      }
      .icon-calendar {
        width: 26px;
        height: 26px;
      }

      .content {
        flex: 1;
        padding: 0 40px;
        display: flex;
        padding-top: 30px;
        padding-left: 40px;
        flex-direction: column;
        margin-left: 22px;
      }

      .mission-container {
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        width: 900px;
        height: 100%;
        margin: 0 auto;
        padding-bottom: 10px;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
        border-top-right-radius: 15px;
        overflow: hidden;
      }

      .mission-top-bar {
        display: flex;
        justify-content: flex-end;
        width: 100%;
        height: 50px;
      }

      .gray-triangle {
        width: 0;
        height: 0;
        border-top: 50px solid transparent;
        border-right: 52px solid #e8e8e8;
        flex-shrink: 0;
      }

      .gray-box-right {
        width: 400px;
        background-color: #e8e8e8;
        height: 100%;
        border-top-right-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .mission-icon {
        width: 20px;
        height: 20px;
      }

      .mission-title {
        font-size: 22px;
        font-weight: 600;
        color: #247eb6;
      }

      .question-body {
        padding-left: 80px;
        padding-right: 80px;
        padding-top: 40px;
      }

      .question-text {
        font-size: 25px;
        line-height: 1.5;
        margin-bottom: 30px;
      }

      .answer-options {
        display: flex;
        flex-direction: column;
        padding-bottom: 10px;
        gap: 5px;
      }

      .answer-option {
        font-size: 23px;
        margin-bottom: 20px;
      }

      .choice-buttons {
        display: flex;
        justify-content: space-around;
        margin-top: 40px;
      }

      .choice-button {
        width: 120px;
        height: 50px;
        border-radius: 10px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f3faff;
        border: 1px solid #e6f4fd;
        color: #247eb6;
        transition: background-color 0.2s, border-color 0.2s;
      }

      .choice-button:hover {
        background-color: #e6f4fd;
      }

      .answer-result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        text-align: left;
        background-color: #f8fafd;
        border: 1px solid #e1e1e1;
        display: none;
      }

      .answer-result h1,
      .answer-result h2 {
        text-align: center;
      }

      .answer-result .center-text {
        text-align: center;
      }

      .answer-result h3 {
        text-align: left;
        margin-left: 0;
        padding-left: 0;
      }

      .choice-button.correct {
        background-color: #28a745 !important; /* ì´ˆë¡ìƒ‰ */
        color: white;
        border-color: #28a745;
      }

      .choice-button.wrong {
        background-color: #dc3545 !important; /* ë¹¨ê°„ìƒ‰ */
        color: white;
        border-color: #dc3545;
      }

      /* ë¬¸ì œ ë‹µë³€ ì œì¶œ ë¡œë”© ì˜¤ë²„ë ˆì´ */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 20;
        font-size: 24px;
        color: #247eb6;
        flex-direction: column;
        gap: 15px;
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
      }
      .loading-overlay img {
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <div class="blur-circle blur-circle-1"></div>
    <div class="blur-circle blur-circle-2"></div>
    <div class="header">
      <div class="logo">
        <img src="./icons/tutti.png" alt="Tutti ë¡œê³ " />
      </div>
      <div class="user-actions">
        <div class="nav-box" onclick="location.href='CommuForm.html'">í™ˆ</div>
        <div
          class="nav-box notification"
          onclick="location.href='MyPageAlerts.html'"
        >
          ì•Œë¦¼
          <span class="badge">0</span>
        </div>
        <div class="profile-btn" onclick="location.href='MyPage.html'">
          <img id="profileImage" src="./icons/profile.png" alt="í”„ë¡œí•„" />
        </div>
      </div>
    </div>

    <div class="wrapper">
      <div class="sidebar">
        <h2>TOEIC ì»¤ë®¤ë‹ˆí‹°</h2>
        <div class="stats">
          <div class="stat-item">
            <img src="./icons/user.png" class="user-icon" alt="ìœ ì € ì•„ì´ì½˜" />
            <span>85ëª…</span>
          </div>
          <div class="stat-item">
            <img
              src="./icons/calendar-blue.png"
              class="calendar-icon"
              alt="ë‹¬ë ¥ ì•„ì´ì½˜"
            />
            <span>8/24</span>
          </div>
          <div class="stat-item">
            <img src="./icons/day.png" class="day-icon" alt="D-day ì•„ì´ì½˜" />
            <span>D-61</span>
          </div>
        </div>

        <div class="write-button" onclick="location.href='PostUpload.html'">
          <img src="./icons/pencil.png" alt="ê¸€ì“°ê¸° ì•„ì´ì½˜" />
          <span>ê¸€ì“°ê¸°</span>
        </div>

        <ul id="menu-list">
          <li data-title="ì „ì²´ê¸€" data-icon="all" class="menu-item">
            <a href="Community.html" class="menu-item-link">
              <img src="./icons/all-gray.png" class="icon-all" />
              <span>ì „ì²´ê¸€</span>
            </a>
          </li>

          <li data-title="ì¸ê¸°ê¸€" data-icon="star" class="menu-item">
            <a href="hot.html" class="menu-item-link">
              <img src="./icons/star-gray.png" class="icon-star" />
              <span>ì¸ê¸°ê¸€</span>
            </a>
          </li>

          <li data-title="ì •ë³´ê¸€" data-icon="info" class="menu-item">
            <a href="Info.html" class="menu-item-link">
              <img src="./icons/info-gray.png" class="icon-info" />
              <span>ì •ë³´ê¸€</span>
            </a>
          </li>

          <li data-title="ìŠ¤í„°ë”” ëª¨ì§‘" data-icon="group" class="menu-item">
            <a href="group.html" class="menu-item-link">
              <img src="./icons/group-gray.png" class="icon-group" />
              <span>ìŠ¤í„°ë”” ëª¨ì§‘</span>
            </a>
          </li>

          <li
            id="mission-menu"
            data-title="ë¯¸ì…˜"
            data-icon="mission"
            class="menu-item"
          >
            <a href="Mission.html" class="mission-main-link">
              <img src="./icons/mission-blue.png" class="icon-mission" />
              <span>ë¯¸ì…˜</span>
            </a>
            <ul id="mission-submenu">
              <li>
                <a href="MissionSolve.html">
                  <img src="./icons/question.png" alt="â€¢" />
                  <span>ë¯¸ì…˜í’€ê¸°</span>
                </a>
              </li>
              <li>
                <a href="WrongNote.html">
                  <img src="./icons/question.png" alt="â€¢" />
                  <span>ì˜¤ë‹µë…¸íŠ¸</span>
                </a>
              </li>
            </ul>
          </li>

          <li data-title="ì‹œí—˜ ì¼ì •" data-icon="calendar" class="menu-item">
            <a href="Calendar.html" class="menu-item-link">
              <img src="./icons/calendar-gray.png" class="icon-calendar" />
              <span>ì‹œí—˜ ì¼ì •</span>
            </a>
          </li>
        </ul>
      </div>

      <div class="content">
        <div class="mission-container">
          <div class="loading-overlay" id="loadingOverlay">
            <span>ë¬¸ì œ ë¡œë“œ ì¤‘...</span>
          </div>

          <div class="mission-top-bar">
            <div class="gray-triangle"></div>

            <div class="gray-box-right">
              <img
                src="./icons/mission-blue.png"
                alt="ë¯¸ì…˜"
                class="mission-icon"
              />
              <span class="mission-title">ë¯¸ì…˜</span>
            </div>
          </div>
          <div class="question-body">
            <div class="question-text">ë¬¸ì œë¥¼ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...</div>
            <div class="answer-options"></div>
            <div class="choice-buttons"></div>
            <div id="answerResult" class="answer-result"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="./config.js"></script>

    <script>
      window.nextQuestion = function () {
        if (currentIndex < wrongQuestions.length - 1) {
          showWrongQuestion(currentIndex + 1);
        }
      };

      window.prevQuestion = function () {
        if (currentIndex > 0) {
          showWrongQuestion(currentIndex - 1);
        }
      };
      let currentProblem = null;

      const missionMenu = document.getElementById("mission-menu");
      const subMenu = document.getElementById("mission-submenu");
      const mainMissionLink = missionMenu.querySelector(".mission-main-link");
      const mainMissionIcon = mainMissionLink.querySelector(".icon-mission");

      // í˜„ì¬ ë¡œë“œëœ ë¬¸ì œ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
      let originalQuestionText = ""; // ë¬¸ì œ ë³¸ë¬¸ì˜ ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì €ì¥í•  ë³€ìˆ˜

      function updateIconSrc(imgElement, isActive, defaultSrc, activeSrc) {
        if (!imgElement) return;
        if (isActive) {
          imgElement.src = activeSrc;
        } else {
          imgElement.src = defaultSrc;
        }
      }

      if (missionMenu) {
        missionMenu.addEventListener("click", (event) => {
          const clickedLink = event.target.closest("a");

          if (
            clickedLink &&
            clickedLink.classList.contains("mission-main-link")
          ) {
            const isVisible = subMenu.style.display === "block";
            subMenu.style.display = isVisible ? "none" : "block";

            updateIconSrc(
              mainMissionIcon,
              false,
              "./icons/mission-gray.png",
              "./icons/mission-blue.png"
            );
            mainMissionLink.classList.remove("active");

            subMenu.querySelectorAll("a").forEach((subLink) => {
              subLink.classList.remove("active");
              subLink.querySelector("img").src = "./icons/question.png";
            });
          } else if (clickedLink && subMenu.contains(clickedLink)) {
            subMenu.querySelectorAll("a").forEach((subLink) => {
              subLink.classList.remove("active");
              subLink.querySelector("img").src = "./icons/question.png";
            });

            clickedLink.classList.add("active");

            mainMissionLink.classList.remove("active");
            updateIconSrc(
              mainMissionIcon,
              false,
              "./icons/mission-gray.png",
              "./icons/mission-blue.png"
            );
          }
        });
      }

      window.addEventListener("DOMContentLoaded", () => {
        const menuItems = document.querySelectorAll(".menu-item");
        const currentPath = window.location.pathname.split("/").pop();

        menuItems.forEach((item) => {
          const linksInItem = item.querySelectorAll(
            "a.menu-item-link, a.mission-main-link, #mission-submenu a"
          );
          let isActiveMenuItem = false;

          linksInItem.forEach((link) => {
            if (link.getAttribute("href") === currentPath) {
              link.classList.add("active");
              isActiveMenuItem = true;

              const img = link.querySelector("img");
              if (img) {
                if (
                  link.classList.contains("menu-item-link") &&
                  !link.classList.contains("mission-main-link")
                ) {
                  updateIconSrc(
                    img,
                    true,
                    img.src.replace("-blue", "-gray"),
                    img.src.replace("-gray", "-blue")
                  );
                } else if (subMenu.contains(link)) {
                  // ë¯¸ì…˜ ì„œë¸Œë©”ë‰´ ì•„ì´í…œ (question.pngëŠ” ë³€ê²½ë˜ì§€ ì•ŠìŒ)
                  // ì„œë¸Œë©”ë‰´ í•­ëª©ì„ í´ë¦­í–ˆì„ ë•Œ ë©”ì¸ ë¯¸ì…˜ ì•„ì´ì½˜ì„ íŒŒë€ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ë¯¸ì…˜ ì„¹ì…˜ í™œì„±í™”)
                  updateIconSrc(
                    mainMissionIcon,
                    true,
                    "./icons/mission-gray.png",
                    "./icons/mission-blue.png"
                  );
                } else if (link.classList.contains("mission-main-link")) {
                  // ë¯¸ì…˜ ë©”ì¸ ë§í¬ ìì²´ ( Mission.html ë¡œë“œ ì‹œ)
                  updateIconSrc(
                    img,
                    true,
                    "./icons/mission-gray.png",
                    "./icons/mission-blue.png"
                  );
                }
              }
            } else {
              // í˜„ì¬ í˜ì´ì§€ê°€ ì•„ë‹Œ ë§í¬
              link.classList.remove("active");
              if (
                !subMenu.contains(link) && // ì„œë¸Œë©”ë‰´ ë§í¬ê°€ ì•„ë‹ˆê³ 
                !link.classList.contains("mission-main-link") // ë©”ì¸ ë¯¸ì…˜ ë§í¬ê°€ ì•„ë‹Œ ê²½ìš°
              ) {
                const img = link.querySelector("img");
                if (img && img.src.includes("-blue")) {
                  img.src = img.src.replace("-blue", "-gray");
                }
              }
            }
          });

          // íŠ¹ì • ë¯¸ì…˜ ê´€ë ¨ í˜ì´ì§€ì¼ ë•Œ ì„œë¸Œë©”ë‰´ ìë™ ì—´ë¦¼
          if (item.id === "mission-menu") {
            const subMenu = item.querySelector("#mission-submenu");
            if (subMenu) {
              if (
                currentPath === "Mission.html" ||
                currentPath === "MissionSolve.html" ||
                currentPath === "WrongNote.html"
              ) {
                subMenu.style.display = "block";

                const mainMissionLink =
                  item.querySelector(".mission-main-link");
                if (mainMissionLink) {
                  // ë¯¸ì…˜ ì„œë¸Œ í˜ì´ì§€ì— ìˆì„ ë•Œ ë©”ì¸ ë¯¸ì…˜ ì•„ì´ì½˜ì„ íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                  updateIconSrc(
                    mainMissionIcon,
                    true, // í™œì„± ìƒíƒœë¡œ í‘œì‹œ
                    "./icons/mission-gray.png",
                    "./icons/mission-blue.png"
                  );
                }
              } else {
                subMenu.style.display = "none";
                const mainMissionLink =
                  item.querySelector(".mission-main-link");
                if (mainMissionLink) {
                  // ë¯¸ì…˜ ê´€ë ¨ í˜ì´ì§€ê°€ ì•„ë‹ ë•Œ ë©”ì¸ ë¯¸ì…˜ ì•„ì´ì½˜ì„ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ
                  updateIconSrc(
                    mainMissionIcon,
                    false,
                    "./icons/mission-gray.png",
                    "./icons/mission-blue.png"
                  );
                }
              }
            }
          }
        });
        // âœ… ì˜¤ë‹µë…¸íŠ¸ ê¸°ëŠ¥ ì „ìš©: í‹€ë¦° ë¬¸ì œë“¤ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì¢Œìš° í™”ì‚´í‘œ íƒìƒ‰

        // ====================================================================
        // ì´ ì•„ë˜ë¶€í„° ë°±ì—”ë“œ API ì—°ë™ ë° ë¬¸ì œ ë¡œë”© ë¡œì§ì…ë‹ˆë‹¤.
        // ====================================================================

        const questionTextElement = document.querySelector(".question-text");
        const answerOptionsContainer =
          document.querySelector(".answer-options");
        const choiceButtonsContainer =
          document.querySelector(".choice-buttons");
        const answerResultDiv = document.getElementById("answerResult");
        const loadingOverlay = document.getElementById("loadingOverlay");

        // ë¯¸ì…˜ ë¬¸ì œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchMissionQuestion(communityId) {
          loadingOverlay.style.display = "flex"; // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
          try {
            const token = localStorage.getItem("accessToken");
            if (!token) {
              console.error("ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
              alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
              window.location.href = "index.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
              return null;
            }

            const response = await fetch(
              `${window.BASE_URL}/api/communities/${communityId}/missions/problem`,
              {
                method: "GET",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              }
            );
            if (!response.ok) {
              if (response.status === 404) {
                questionTextElement.textContent =
                  "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.";
                answerOptionsContainer.innerHTML = "";
                choiceButtonsContainer.innerHTML = "";
                answerResultDiv.style.display = "none";
                currentProblem = null; // ë¬¸ì œ ì—†ìŒ ìƒíƒœ
                return null;
              }
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const responseData = await response.json();
            if (responseData.status === "success" && responseData.data) {
              return responseData.data;
            } else {
              console.error(
                "API ì‘ë‹µì—ì„œ ë¬¸ì œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:",
                responseData.message
              );
              currentProblem = null; // ë¬¸ì œ ì—†ìŒ ìƒíƒœ
              return null;
            }
          } catch (error) {
            console.error("ë¯¸ì…˜ ë¬¸ì œë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
            questionTextElement.textContent =
              "ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            answerOptionsContainer.innerHTML = "";
            choiceButtonsContainer.innerHTML = "";
            answerResultDiv.style.display = "none";
            currentProblem = null; // ë¬¸ì œ ì—†ìŒ ìƒíƒœ
            return null;
          } finally {
            loadingOverlay.style.display = "none"; // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
          }
        }

        // ë¬¸ì œë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderQuestion(problem) {
          currentProblem = problem; // í˜„ì¬ ë¬¸ì œ ë°ì´í„° ì €ì¥
          originalQuestionText = problem ? problem.content : ""; // ì›ë³¸ ë¬¸ì œ í…ìŠ¤íŠ¸ ì €ì¥

          if (!problem) {
            questionTextElement.textContent = "ë¬¸ì œë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            answerOptionsContainer.innerHTML = "";
            choiceButtonsContainer.innerHTML = "";
            answerResultDiv.style.display = "none";
            return;
          }

          // 1. ë¬¸ì œ í…ìŠ¤íŠ¸ ì„¤ì •: problem.content ì‚¬ìš© (ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ì´ˆê¸°í™”)
          questionTextElement.textContent = originalQuestionText;
          answerOptionsContainer.innerHTML = ""; // ê¸°ì¡´ ë³´ê¸°ë“¤ì„ ë¹„ì›ë‹ˆë‹¤.
          choiceButtonsContainer.innerHTML = ""; // ê¸°ì¡´ ì„ íƒ ë²„íŠ¼ë“¤ì„ ë¹„ì›ë‹ˆë‹¤.
          answerResultDiv.style.display = "none"; // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™” ë° ìˆ¨ê¹€
          answerResultDiv.classList.remove("correct", "wrong"); // í´ë˜ìŠ¤ ì œê±°

          // ë³´ê¸°ì— ì‚¬ìš©í•  ì•ŒíŒŒë²³ ë ˆì´ë¸” (A, B, C, D) ìƒì„±
          const choiceLabels = ["A", "B", "C", "D", "E", "F"]; // ìµœëŒ€ ë³´ê¸° ê°œìˆ˜ì— ë§ê²Œ í™•ì¥ ê°€ëŠ¥

          problem.options.forEach((optionText, index) => {
            // 2. ë³´ê¸° ë Œë”ë§ (ë³´ê¸° í…ìŠ¤íŠ¸ë§Œ, ì§ì ‘ ì„ íƒ ë¶ˆê°€)
            const answerOptionDiv = document.createElement("div");
            answerOptionDiv.classList.add("answer-option");
            answerOptionDiv.textContent = optionText; // (A), (B), (C), (D) ë ˆì´ë¸” ì—†ì´ í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ
            answerOptionsContainer.appendChild(answerOptionDiv);

            // 3. ì„ íƒ ë²„íŠ¼ ë Œë”ë§ (A, B, C, D ë²„íŠ¼)
            const choiceButtonDiv = document.createElement("div");
            choiceButtonDiv.classList.add("choice-button");
            choiceButtonDiv.dataset.choice = optionText; // ì„ íƒ ë²„íŠ¼ì— ë³´ê¸° í…ìŠ¤íŠ¸ ì €ì¥
            choiceButtonDiv.textContent = choiceLabels[index]; // ë²„íŠ¼ì—ëŠ” A, B, C, D í‘œì‹œ

            // âœ… ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ë³´ê¸°ë¥¼ 'selected' ìƒíƒœë¡œ ë§Œë“¤ê³  ì¦‰ì‹œ ì œì¶œ
            choiceButtonDiv.addEventListener("click", () => {
              // ëª¨ë“  answer-optionì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
              document
                .querySelectorAll(".answer-option")
                .forEach((opt) => opt.classList.remove("selected"));
              // í´ë¦­ëœ ë²„íŠ¼ì— í•´ë‹¹í•˜ëŠ” answer-optionì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
              const targetOption = answerOptionsContainer.children[index];
              if (targetOption) {
                targetOption.classList.add("selected");
              }
              submitAnswer(problem.problemId, optionText); // ì‹¤ì œ ì œì¶œì€ ë³´ê¸° í…ìŠ¤íŠ¸ë¡œ
            });

            choiceButtonsContainer.appendChild(choiceButtonDiv);
          });

          // ë¬¸ì œ IDë¥¼ ìˆ¨ê²¨ì§„ ìš”ì†Œì— ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— ë‹µë³€ ì œì¶œ ì‹œ ì‚¬ìš©
          let hiddenProblemIdInput =
            document.getElementById("currentProblemId");
          if (!hiddenProblemIdInput) {
            hiddenProblemIdInput = document.createElement("input");
            hiddenProblemIdInput.type = "hidden";
            hiddenProblemIdInput.id = "currentProblemId";
            document.body.appendChild(hiddenProblemIdInput); // bodyì— ì¶”ê°€
          }
          hiddenProblemIdInput.value = problem.problemId;
        }

        // ë‹µë³€ ì œì¶œ í•¨ìˆ˜ (ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
        async function submitAnswer(problemId, selectedAnswerValue) {
          const token = localStorage.getItem("accessToken");
          if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "index.html";
            return;
          }

          // í˜„ì¬ ì„ íƒëœ ë³´ê¸°ì˜ ì¸ë±ìŠ¤ë¥¼ ì°¾ì•„ í•´ë‹¹ ë²„íŠ¼ì„ ì‹ë³„í•©ë‹ˆë‹¤.
          let selectedButtonIndex = -1;
          if (currentProblem && currentProblem.options) {
            selectedButtonIndex = currentProblem.options.findIndex(
              (text) => text.trim() === selectedAnswerValue.trim()
            );
          }

          const allButtons = document.querySelectorAll(".choice-button");
          const selectedButton = allButtons?.[selectedButtonIndex];
          const answerOptions = document.querySelectorAll(".answer-option");
          const selectedOptionElement = answerOptions?.[selectedButtonIndex];
          const questionTextElement = document.querySelector(".question-text");

          // ëª¨ë“  ë³´ê¸° ë° ì„ íƒ ë²„íŠ¼ ë¹„í™œì„±í™” (ë‹µë³€ ì œì¶œ ì¤‘ ì¤‘ë³µ í´ë¦­ ë°©ì§€)
          document
            .querySelectorAll(".answer-option, .choice-button")
            .forEach((el) => {
              el.style.pointerEvents = "none";
              el.style.cursor = "default";
            });

          loadingOverlay.style.display = "flex";

          try {
            const response = await fetch(
              `${window.BASE_URL}/api/problem/${problemId}/submit`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ selectedAnswer: selectedAnswerValue }),
              }
            );

            // HTTP ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ê²½ìš° (ì˜ˆ: 4xx, 5xx)
            if (!response.ok) {
              let errorData = {};
              try {
                errorData = await response.json();
              } catch (e) {
                console.warn("Error parsing error response:", e);
              }
              throw new Error(
                `HTTP error! status: ${response.status}, message: ${
                  errorData.message || response.statusText
                }`
              );
            }

            const result = await response.json();
            console.log("ğŸ¯ ì‘ë‹µ ê²°ê³¼:", result);
            console.log("âœ… ì„œë²„ ì‘ë‹µì—ì„œ ì •ë‹µ:", result.data?.correctAnswer);
            console.log("âœ… ì„œë²„ ì‘ë‹µì—ì„œ í•´ì„¤:", result.data?.explanation);

            const isCorrect = result.data?.correct === true;
            const correctAnswer = result.data?.correctAnswer;

            // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
            answerResultDiv.style.display = "block";
            answerResultDiv.classList.remove("correct", "wrong");
            answerResultDiv.classList.add(isCorrect ? "correct" : "wrong");

            if (isCorrect) {
              if (selectedButton) {
                selectedButton.classList.add("correct");
              }
              answerResultDiv.innerHTML = `
                      <h1>ğŸ¥³</h1>
          <br><h2>ì •ë‹µì…ë‹ˆë‹¤!</h2><br>
          <p class="center-text">ê³„ì† ë¬¼ì–´ë³¼ê¹Œìš”?</p><br>
          <br>
          <h3>í•´ì„¤</h3><br> ${
            result.data?.explanation || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤."
          }<br>
                    `;
            } else {
              if (selectedButton) {
                selectedButton.classList.add("wrong");
              }
              if (selectedOptionElement) {
                selectedOptionElement.classList.add("wrong"); // ì˜¤ë‹µìœ¼ë¡œ ì„ íƒí•œ ë³´ê¸° ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½ (í´ë˜ìŠ¤ ì‚¬ìš©)
              }
              answerResultDiv.innerHTML = `
          <h1>ğŸ¤”</h1>
          <br><h2>ì˜¤ë‹µì…ë‹ˆë‹¤! í•˜ì§€ë§Œ ê±±ì •ë§ˆì„¸ìš”!</h2><br>
          <p class="center-text">ë‹¤ë¥¸ ë¬¸ì œë¥¼ ë” í’€ ê¸°íšŒê°€ ìˆìœ¼ë‹ˆê¹Œìš”!</p><br>
          <h3>ì •ë‹µ</h3>
          <br> '${correctAnswer}' <br>
          <br>
          <h3>í•´ì„¤</h3><br> ${
            result.data?.explanation || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤."
          }<br>
      `;

              // ë¬¸ì œ ë³¸ë¬¸ì—ì„œ ì •ë‹µ ë‹¨ì–´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
              if (
                correctAnswer &&
                questionTextElement &&
                originalQuestionText
              ) {
                // ì›ë³¸ í…ìŠ¤íŠ¸ì—ì„œ ì •ë‹µ ë‹¨ì–´ë¥¼ ì°¾ì•„ ê°•ì¡°
                const regex = new RegExp(`\\b${correctAnswer}\\b`, "gi");
                questionTextElement.innerHTML = originalQuestionText.replace(
                  regex,
                  `<span class="highlight-wrong-answer">${correctAnswer}</span>`
                );
              }
            }

            // 2ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œ ë¡œë“œ ë˜ëŠ” ìƒíƒœ ì´ˆê¸°í™”
            setTimeout(async () => {
              const nextProblemData = await fetchMissionQuestion(communityId);
              if (nextProblemData) {
                renderQuestion(nextProblemData);
              } else {
                questionTextElement.textContent =
                  "ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ì„ ëª¨ë‘ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!";
                answerOptionsContainer.innerHTML = "";
                choiceButtonsContainer.innerHTML = "";
                answerResultDiv.style.display = "none";
                currentProblem = null; // ë¬¸ì œ ì—†ìŒ ìƒíƒœ ì´ˆê¸°í™”
              }

              // ëª¨ë“  ë³´ê¸° ë° ì„ íƒ ë²„íŠ¼ í´ë¦­ ë‹¤ì‹œ í™œì„±í™” ë° ìƒíƒœ ì´ˆê¸°í™”
              document.querySelectorAll(".answer-option").forEach((option) => {
                option.style.pointerEvents = "auto";
                option.style.cursor = "default";
                option.classList.remove("selected", "wrong"); // ì„ íƒ ë° ì˜¤ë‹µ í´ë˜ìŠ¤ ì œê±°
              });
              document.querySelectorAll(".choice-button").forEach((button) => {
                button.classList.remove("correct", "wrong");
                button.style.pointerEvents = "auto";
                button.style.cursor = "pointer";
              });
              loadingOverlay.style.display = "none";
            }, 10000);
          } catch (error) {
            console.error("âŒ ë‹µë³€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            if (selectedButton) {
              selectedButton.classList.add("wrong");
            }
            answerResultDiv.style.display = "block";
            answerResultDiv.classList.add("wrong");
            answerResultDiv.textContent = `ë‹µë³€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;

            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            document.querySelectorAll(".answer-option").forEach((option) => {
              option.style.pointerEvents = "auto";
              option.style.cursor = "default";
            });
            document.querySelectorAll(".choice-button").forEach((button) => {
              button.classList.remove("correct", "wrong");
              button.style.pointerEvents = "auto";
              button.style.cursor = "pointer";
            });
            loadingOverlay.style.display = "none";
          }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¯¸ì…˜ ë¬¸ì œ ê°€ì ¸ì˜¤ê¸°
        const communityId = "1"; // ì˜ˆì‹œ: ì»¤ë®¤ë‹ˆí‹° IDë¥¼ 1ë¡œ ê³ ì •. ì‹¤ì œ ì‚¬ìš© ì‹œ ë™ì ìœ¼ë¡œ ë°›ì•„ì™€ì•¼ í•¨.

        if (communityId) {
          console.log("ìš”ì²­í•  communityId:", communityId);
          fetchWrongQuestions();
        } else {
          console.warn(
            "communityIdê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );
          questionTextElement.textContent =
            "ì»¤ë®¤ë‹ˆí‹° IDê°€ ì—†ì–´ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¯¸ì…˜ ëª©ë¡ì—ì„œ ë¯¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
          answerOptionsContainer.innerHTML = "";
          choiceButtonsContainer.innerHTML = "";
          answerResultDiv.style.display = "none";
        }
        let wrongQuestions = [];
        let currentIndex = 0;

        async function fetchWrongQuestions() {
          loadingOverlay.style.display = "flex";
          try {
            const token = localStorage.getItem("accessToken");
            const res = await fetch(
              `${window.BASE_URL}/api/users/me/missions/wrong-questions`,
              {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              }
            );
            const json = await res.json();
            if (json.status === "success" && json.data.length > 0) {
              wrongQuestions = json.data;
              showWrongQuestion(0);
            } else {
              questionTextElement.textContent = "í‹€ë¦° ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!";
              answerOptionsContainer.innerHTML = "";
              choiceButtonsContainer.innerHTML = "";
            }
          } catch (err) {
            console.error("ì˜¤ë‹µë…¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            questionTextElement.textContent =
              "ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          } finally {
            loadingOverlay.style.display = "none";
          }
        }
        console.log("wrongQuestions ë°°ì—´:", wrongQuestions);
        function nextQuestion() {
          console.log("ğŸ‘‰ ë‹¤ìŒ ë¬¸ì œ í´ë¦­ë¨");
          if (currentIndex < wrongQuestions.length - 1) {
            showWrongQuestion(currentIndex + 1);
          } else {
            console.log("âš ï¸ ë” ì´ìƒ ë‹¤ìŒ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤");
          }
        }

        function showWrongQuestion(index) {
          const q = wrongQuestions[index];
          currentIndex = index;
          questionTextElement.textContent = q.content;
          answerOptionsContainer.innerHTML = `
          <div class="answer-option"><strong>ë‚´ ì˜¤ë‹µ:</strong> ${q.selectedAnswer}</div>
          <div class="answer-option"><strong>ì •ë‹µ:</strong> ${q.correctAnswer}</div>
        `;
          choiceButtonsContainer.innerHTML = `
          <button class="choice-button" onclick="prevQuestion()">â† ì´ì „</button>
          <button class="choice-button" onclick="nextQuestion()">ë‹¤ìŒ â†’</button>
        `;
          answerResultDiv.style.display = "block";
          answerResultDiv.innerHTML = `
          <h3>í•´ì„¤</h3><br>${q.explanation}
        `;
        }

        function prevQuestion() {
          if (currentIndex > 0) {
            showWrongQuestion(currentIndex - 1);
          }
        }

        function nextQuestion() {
          if (currentIndex < wrongQuestions.length - 1) {
            showWrongQuestion(currentIndex + 1);
          }
        }
      });
    </script>
  </body>
</html>
